services:
  # Service Registry (Eureka)
  service-registry:
    build:
      context: ./backend
      dockerfile: service-registry/Dockerfile
    container_name: service-registry
    image: service-registry:latest
    ports:
      - "8761:8761"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_SECURITY_USER_NAME=eureka
      - SPRING_SECURITY_USER_PASSWORD=eureka123
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8761/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Config Server
  config-server:
    build:
      context: ./backend
      dockerfile: config-server/Dockerfile
    container_name: config-server
    image: config-server:latest
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=native,docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
    depends_on:
      service-registry:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8888/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # PostgreSQL Database for User Service
  postgres-user:
    image: postgres:15-alpine
    container_name: postgres-user
    environment:
      - POSTGRES_DB=user_db
      - POSTGRES_USER=hiba
      - POSTGRES_PASSWORD=hiba
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5432:5432"
    volumes:
      - postgres-user-data:/var/lib/postgresql/data
      - ./backend/user-service/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
    networks:
      - transport-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hiba -d user_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # PostgreSQL Database for Schedule Service
  postgres-schedule:
    image: postgres:15-alpine
    container_name: postgres-schedule
    environment:
      - POSTGRES_DB=schedule_db
      - POSTGRES_USER=hiba
      - POSTGRES_PASSWORD=hiba
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5433:5432"
    volumes:
      - postgres-schedule-data:/var/lib/postgresql/data
      - ./backend/schedule-service/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
    networks:
      - transport-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hiba -d schedule_db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # PostgreSQL Database for Subscription Service
  postgres-subscription:
    image: postgres:15-alpine
    container_name: postgres-subscription
    environment:
      - POSTGRES_DB=subscription_service
      - POSTGRES_USER=hiba
      - POSTGRES_PASSWORD=hiba
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5434:5432"
    volumes:
      - postgres-subscription-data:/var/lib/postgresql/data
      - ./backend/subscription-service/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
    networks:
      - transport-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hiba -d subscription_service"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped
# PostgreSQL Database for Notification  Service
  postgres-notification:
    image: postgres:15-alpine
    container_name: postgres-notification
    environment:
      - POSTGRES_DB=notification_service
      - POSTGRES_USER=hiba
      - POSTGRES_PASSWORD=hiba
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5436:5432"
    volumes:
      - postgres-notification-data:/var/lib/postgresql/data
      - ./backend/notification-service/src/main/resources/db/migration:/docker-entrypoint-initdb.d:ro
    networks:
      - transport-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hiba -d notification_service"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # PostgreSQL Database for Ticket Service
  postgres-ticket:
    image: postgres:15-alpine
    container_name: postgres-ticket
    environment:
      - POSTGRES_DB=ticket-service-db
      - POSTGRES_USER=hiba
      - POSTGRES_PASSWORD=hiba
      - POSTGRES_INITDB_ARGS=--encoding=UTF-8 --lc-collate=C --lc-ctype=C
    ports:
      - "5435:5432"
    volumes:
      - postgres-ticket-data:/var/lib/postgresql/data
    networks:
      - transport-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U hiba -d ticket-service-db"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  # MongoDB Database for Geolocation Service
  mongodb:
    image: mongo:7.0
    container_name: mongodb
    environment:
      - MONGO_INITDB_DATABASE=geolocation_db
      - MONGO_INITDB_ROOT_USERNAME=hiba
      - MONGO_INITDB_ROOT_PASSWORD=hiba
    ports:
      - "27017:27017"
    volumes:
      - mongodb-data:/data/db
    networks:
      - transport-network
    healthcheck:
      test: ["CMD-SHELL", "mongosh --quiet --eval \"db.adminCommand('ping')\" > /dev/null"]
      interval: 20s
      timeout: 15s
      retries: 10
      start_period: 30s
    restart: unless-stopped

  # User Service
  user-service:
    build:
      context: ./backend
      dockerfile: user-service/Dockerfile
    container_name: user-service
    image: user-service:latest
    ports:
      - "8081:8081"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-user:5432/user_db
      - SPRING_DATASOURCE_USERNAME=hiba
      - SPRING_DATASOURCE_PASSWORD=hiba
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
    depends_on:
      postgres-user:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Schedule Service
  schedule-service:
    build:
      context: ./backend
      dockerfile: schedule-service/Dockerfile
    container_name: schedule-service
    image: schedule-service:latest
    ports:
      - "8083:8083"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - SPRING_CLOUD_CONFIG_IMPORT_CHECK_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-schedule:5432/schedule_db
      - SPRING_DATASOURCE_USERNAME=hiba
      - SPRING_DATASOURCE_PASSWORD=hiba
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
    depends_on:
      postgres-schedule:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8083/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped
  # Subscription Service
  subscription-service:
    build:
      context: ./backend
      dockerfile: subscription-service/Dockerfile
    container_name: subscription-service
    image: subscription-service:latest
    ports:
      - "8085:8085"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - SPRING_CLOUD_CONFIG_IMPORT_CHECK_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-subscription:5432/subscription_service
      - SPRING_DATASOURCE_USERNAME=hiba
      - SPRING_DATASOURCE_PASSWORD=hiba
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/  # ‚Üê Ajouter cette ligne
      - EUREKA_CLIENT_ENABLED=true
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
      - EUREKA_INSTANCE_HOSTNAME=subscription-service
    depends_on:
      postgres-subscription:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8085/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped
  # Ticket Service
  ticket-service:
    build:
      context: ./backend
      dockerfile: ticket-service/Dockerfile
    container_name: ticket-service
    image: ticket-service:latest
    ports:
      - "8082:8082"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - SPRING_CLOUD_CONFIG_IMPORT_CHECK_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-ticket:5432/ticket-service-db
      - SPRING_DATASOURCE_USERNAME=hiba
      - SPRING_DATASOURCE_PASSWORD=hiba
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
      - EUREKA_CLIENT_ENABLED=true
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
      - EUREKA_INSTANCE_HOSTNAME=ticket-service
    depends_on:
      postgres-ticket:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "-u", "admin:admin123", "http://localhost:8082/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Geolocation Service
  geolocation-service:
    build:
      context: ./backend
      dockerfile: geolocation-service/Dockerfile
    container_name: geolocation-service
    image: geolocation-service:latest
    ports:
      - "8084:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_DATA_MONGODB_URI=mongodb://hiba:hiba@mongodb:27017/geolocation_db?authSource=admin
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
    depends_on:
      mongodb:
        condition: service_healthy
      service-registry:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/actuator/health" ]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped
  # API Gateway
  api-gateway:
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
    container_name: api-gateway
    image: api-gateway:latest
    ports:
      - "8080:8080"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
      - SPRING_DATA_REDIS_HOST=redis
      - SPRING_DATA_REDIS_PORT=6379
    depends_on:
      - service-registry
      - user-service
      - schedule-service
      - subscription-service
      - ticket-service
      - geolocation-service
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped


  # Notification Service
  notification-service:
    build:
      context: ./backend
      dockerfile: notification-service/Dockerfile
    container_name: notification-service
    image: notification-service:latest
    ports:
      - "8086:8086"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - SPRING_CLOUD_CONFIG_ENABLED=false
      - SPRING_CLOUD_CONFIG_IMPORT_CHECK_ENABLED=false
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-notification:5432/notification_service
      - SPRING_DATASOURCE_USERNAME=hiba
      - SPRING_DATASOURCE_PASSWORD=hiba
      - EUREKA_CLIENT_SERVICEURL_DEFAULTZONE=http://eureka:eureka123@service-registry:8761/eureka/
      - EUREKA_CLIENT_ENABLED=true
      - EUREKA_INSTANCE_PREFER_IP_ADDRESS=false
      - EUREKA_INSTANCE_HOSTNAME=notification-service
      - SPRING_KAFKA_BOOTSTRAP_SERVERS=kafka:9092
      - MAIL_HOST=smtp.gmail.com
      - MAIL_PORT=587
      - MAIL_USERNAME=${MAIL_USERNAME}
      - MAIL_PASSWORD=${MAIL_PASSWORD}
      - MAIL_FROM=notifications@transport.com
      - SMS_ENABLED=false
      - PUSH_ENABLED=false
      - SERVER_PORT=8086
    depends_on:
      postgres-notification:
        condition: service_healthy
      service-registry:
        condition: service_healthy
      kafka:
        condition: service_healthy
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8086/actuator/health"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s
    restart: unless-stopped

  # Redis (for caching and rate limiting)
  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Kafka (for event streaming)
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    networks:
      - transport-network
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: kafka
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,PLAINTEXT_INTERNAL://kafka:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_INTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT_INTERNAL
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    networks:
      - transport-network
    healthcheck:
      test: ["CMD", "kafka-broker-api-versions", "--bootstrap-server", "localhost:9092"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    restart: unless-stopped

volumes:
  postgres-user-data:
    driver: local
  postgres-schedule-data:
    driver: local
  postgres-subscription-data:
    driver: local
  postgres-ticket-data:
    driver: local
  mongodb-data:
    driver: local
  redis-data:
    driver: local
  postgres-notification-data:
    driver: local  

networks:
  transport-network:
    driver: bridge